{
  "patch": "diff --git a/django/db/models/sql/datastructures.py b/django/db/models/sql/datastructures.py\nindex 1edf040e82..b7e7b7c71e 100644\n--- a/django/db/models/sql/datastructures.py\n+++ b/django/db/models/sql/datastructures.py\n@@ -162,8 +162,15 @@ class Join:\n         return hash(self.identity)\n \n     def equals(self, other):\n-        # Ignore filtered_relation in equality check.\n-        return self.identity[:-1] == other.identity[:-1]\n+        # If both joins have filtered_relation, include it in equality check\n+        if self.filtered_relation is not None and other.filtered_relation is not None:\n+            return self.identity == other.identity\n+        # If neither has filtered_relation, ignore it in equality check\n+        elif self.filtered_relation is None and other.filtered_relation is None:\n+            return self.identity[:-1] == other.identity[:-1]\n+        # If only one has filtered_relation, they are not equal\n+        else:\n+            return False\n \n     def demote(self):\n         new = self.relabeled_clone({})\n"
}