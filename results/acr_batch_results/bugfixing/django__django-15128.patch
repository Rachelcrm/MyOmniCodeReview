{
  "patch": "diff --git a/django/db/models/sql/query.py b/django/db/models/sql/query.py\nindex aaf35ee37c..30e47cc0de 100644\n--- a/django/db/models/sql/query.py\n+++ b/django/db/models/sql/query.py\n@@ -745,7 +745,7 @@ class Query(BaseExpression):\n             for model, values in seen.items():\n                 callback(target, model, values)\n \n-    def table_alias(self, table_name, create=False, filtered_relation=None):\n+    def table_alias(self, table_name, create=False, filtered_relation=None, alias_map=None):\n         \"\"\"\n         Return a table alias for the given table_name and whether this is a\n         new alias or not.\n@@ -761,7 +761,9 @@ class Query(BaseExpression):\n \n         # Create a new alias for this table.\n         if alias_list:\n-            alias = '%s%d' % (self.alias_prefix, len(self.alias_map) + 1)\n+            alias = self.alias_prefix + str(len(self.alias_map) + 1)\n+            while alias in alias_map or alias in self.alias_map:\n+                alias = self.alias_prefix + str(len(self.alias_map) + 1)\n             alias_list.append(alias)\n         else:\n             # The first occurrence of a table uses the table name directly.\n"
}